// skills.c
// Copyright (C) 1995 - 2001, by FengYun Workshop. All rights reserved.
// This software can not be used, copied, or modified in any form without
// the written permission from authors.
// 
// Last modification:
//		- 08/08/2001 by Daniel Q. Yu.
//			* Get name from skill itself.			
//
// 		- 9/22/2002 by Silencer
//			* Add -xxxx to enable single skill check.


#include <ansi.h>

inherit F_CLEAN_UP;
inherit F_LEVEL;

string *skill_level_desc = ({
	BLU "³õÑ§Õ§Á·" NOR,
	HIB "´ÖÍ¨Æ¤Ã«" NOR,
	HIB "°ëÉú²»Êì" NOR,
	HIB "ÂíÂí»¢»¢" NOR,
	HIB "¼İÇá¾ÍÊì" NOR,
	CYN "³öÀà°ÎİÍ" NOR,
	CYN "ÉñºõÆä¼¼" NOR,
	CYN "³öÉñÈë»¯" NOR,
	HIC "µÇ·åÔì¼«" NOR,
	HIC "Ò»´ú×ÚÊ¦" NOR,
	HIW "Éî²»¿É²â" NOR
});

string *knowledge_level_desc = ({
	BLU "ĞÂÑ§Õ§ÓÃ" NOR,
	HIB "³õ¿úÃÅ¾¶" NOR,
	HIB "ÂÔÖªÒ»¶ş" NOR,
	HIB "ÂíÂí»¢»¢" NOR,
	HIB "ÒÑÓĞĞ¡³É" NOR,
	CYN "ĞÄÁìÉñ»á" NOR,
	CYN "ÁËÈ»ì¶ĞØ" NOR,
	CYN "»íÈ»¹áÍ¨" NOR,
	HIC "¾ÙÊÀÎŞË«" NOR,
	HIC "Õğ¹Åîå½ñ" NOR,
	HIW "Éî²»¿É²â" NOR
});

string skill_level(string, int);

int main(object me, string arg)
{
	object ob, *list, couple_ob;
	mapping skl, lrn, map;
	string *sname, *mapped,target,cardname,skill_name, permit, msg;
	int i, marry_flag, skill_level;
	mapping learned_skill_points;
	int estimate,cost, amount, total, j, my_skill,req_exp;
	string *att_skill = ({ "literate", "unarmed", "force", 
							"foreknowledge", "chanting", "move" });
	mapping exp_data;
							
	seteuid(getuid());

//	==> implemented to reduce flooding when player only needs to check a single skill level -- by silencer
	if (arg)
	if (sscanf(arg,"-%s -%d",skill_name,estimate)==2 
		|| sscanf(arg,"-%s",skill_name)==1) {
		if(!find_object(SKILL_D(skill_name)) && file_size(SKILL_D(skill_name)+".c")<0) 
			return notify_fail("¡¸" + skill_name + "¡¹£¬ÓĞÕâÖÖ¼¼ÄÜÂğ£¿\n");	
		if( !(skill_level=me->query_skill(skill_name,1)))
				skill_level = 0;
//			return notify_fail("Äã²¢Ã»ÓĞÑ§¹ıÕâÏî¼¼ÄÜ»òÊÇ¼¼ÄÜµÈ¼¶ÎªÁã¡£\n");
		
		learned_skill_points=me->query_learned();
		
//		return notify_fail("ÄãÃ»ÓĞÑ§¹ıÈÎºÎ¼¼ÄÜ£¬»¹²»ÄÜ²ì¿´¼¼ÄÜµÄ¾ßÌåĞÅÏ¢¡£ÏÈÈ¥Ñ§µãÊ²Ã´°É¡£\n");
			
//		write( "ÄãÄ¿Ç°Ñ§¹ı£º\n\n");		
		write(HIG"©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤\n"NOR);   
		
		if (mapp(learned_skill_points))
		{
			write(sprintf("%s%s%-40s" NOR " - %-10s %3d/%5d\n\n", 
					(learned_skill_points[skill_name] >= (skill_level+1) * (skill_level+1)) ? HIM : "", 
					me->query_skill_mapped(skill_name) ? "  ": "£ª",
					SKILL_D(skill_name)->name() + " (" + skill_name + ")",
					skill_level(SKILL_D(skill_name)->type(), skill_level),
					skill_level, 
					learned_skill_points[skill_name],
			));
		} else
			write(sprintf("%s%s\n\n",
					me->query_skill_mapped(skill_name) ? "  ": "£ª",
					SKILL_D(skill_name)->name() + " (" + skill_name + ")")
					);
			
		msg = sprintf("\t¡¾Îä¹¦ÏµÊı¡¿%-6d¡¾ÉËº¦µÈ¼¶¡¿+%-6d¡¾ÃüÖĞµÈ¼¶¡¿+%-6d\n",
				SKILL_D(skill_name)->effective_level(me),
				SKILL_D(skill_name)->damage_level(me),
				SKILL_D(skill_name)->accuracy_level(me));
		msg += sprintf("\t¡¾Ñ§Ï°ÄÑ¶È¡¿%-6d¡¾ÑĞ¾¿ÄÑ¶È¡¿+%-6d¡¾Á·Ï°¼¶Êı¡¿%-6d\n",
				SKILL_D(skill_name)->skill_difficulty(),
				SKILL_D(skill_name)->skill_difficulty_r(),
				SKILL_D(skill_name)->practice_limit());
		
		if (SKILL_D(skill_name)->eff_parry_level()!=SKILL_D(skill_name)->effective_level())
			msg += sprintf("\t¡¾ÕĞ¼ÜÓĞĞ§ÏµÊı¡¿%-6d\n",
				SKILL_D(skill_name)->eff_parry_level());
		if (SKILL_D(skill_name)->bounce_ratio())
			msg += sprintf("\t¡¾½ğ¸ÕÀàÓĞĞ§ÏµÊı¡¿%-6d¡¾½ğ¸ÕÀà·´µ¯ÏµÊı¡¿%-6d\n",
				SKILL_D(skill_name)->ic_effect(),
				SKILL_D(skill_name)->bounce_ratio());
		write(WHT+msg + "\n"NOR);
		
		// Here a friendly estimation of pot cost
		
		if (mapp(learned_skill_points)){
			j = me->query_skill(skill_name,1);
			if (!estimate|| estimate<=j)	estimate = j+1;
			if (estimate>400)	estimate = 400;
		
			if (me->query_int()<=40)
				amount = (400+30*me->query_int())*2*100;
			else
				amount = to_int((pow(to_float(me->query_int()*10),0.03)*871-950)*173/5*100) ;
						
	        if (me->query("national")=="Ãç×å")	
	        	amount = amount + amount/20;	// Ãñ×åÌØĞÔ      	            	    	
	        amount = amount / SKILL_D(skill_name)->skill_difficulty();        	                 	
	       	if( amount < 1) amount = 1;		// ÖÁÉÙ1£º1 
	       	          
	        for (i=j;i<=estimate-1;i++){
	        	total = total + (i+1)*(i+1)+1;
	       	}
	       	total = total - learned_skill_points[skill_name];	
			cost = total*100/amount+1;
			
			my_skill = estimate-1;
			if ( member_array(skill_name, att_skill) == -1)
	    		my_skill = my_skill * SKILL_D(skill_name)->effective_level(me)/100;
	    	else
	    		my_skill = my_skill * 150/100;	
	    	req_exp = my_skill * my_skill * my_skill/10;
			exp_data = exp_to_level(req_exp);
			
			write(sprintf(YEL"¡¾ÉıÖÁµÚ%d¼¶ËùĞèÇ±ÄÜ¡¿%-6d\t¡¾ËùĞè¾­ÑéµÈ¼¶¡¿£Ì%d £¨%d.%d£¥£©\n" NOR,
						estimate,cost,
							exp_data["level"],
				    		exp_data["sub"]/10,
				    		exp_data["sub"]%10,
				    		));
			
			my_skill = estimate-1;
			if ( member_array(skill_name, att_skill) == -1)
	    		my_skill = my_skill * SKILL_D(skill_name)->effective_level(me)/100;
	    	else
	    		my_skill = my_skill;	
	    	req_exp = my_skill * my_skill * my_skill;
			exp_data = exp_to_level(req_exp);
			
			write(sprintf(YEL"¡¾ÔÄ¶ÁÓĞ¹ØÊé¼®ÉıÖÁµÚ%d¼¶ËùĞè¾­ÑéµÈ¼¶¡¿£Ì%d £¨%d.%d£¥£©\n\n" NOR,
							estimate,
							exp_data["level"],
				    		exp_data["sub"]/10,
				    		exp_data["sub"]%10,
				    		));
		}
			
		if (me->query_temp("timer/check_skill_help")+2 < time())
			SKILL_D(skill_name)->help(me);
		me->set_temp("timer/check_skill_help",time());
		
		write(HIG"©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤\n"NOR);   
		return 1;
	}
	
//	==> single skill check ends.	
	
	
	if(!arg)
		ob = me;
	else{
		ob = present(arg, environment(me));
//        if ( ob->query("SPSKILLS",1)  ) return ob->skills();		 
		if (!ob) ob = find_player(arg);
		if (!ob) ob = find_living(arg);
		if (!ob) return notify_fail("ÄãÒª²ì¿´Ë­µÄ¼¼ÄÜ£¿\n");
	}
	
	target = (string) me->query("marry");	
	if(stringp(target)) couple_ob = find_player(target);
	
	if( ob!=me && !wizardp(me) && !ob->is_apprentice_of(me)
		&& !me->is_apprentice_of(ob) && ob!=couple_ob
		&& !ob->query("skill_public") )
//		&& !ob->query("skill_restrict"))
		return notify_fail("Ö»ÓĞ¹ÜÀí»òÓĞÊ¦Í½/·òÆŞ¹ØÏµµÄÈËÄÜ²ì¿´ËûÈËµÄ¼¼ÄÜ¡£\n");

/*	if (stringp(permit = ob->query("skill_restrict"))) {
		if (member_array(permit, me->query("marks/ok_skill")) == -1)
			return notify_fail("Ö»ÓĞ¹ÜÀí»òÓĞÊ¦Í½/·òÆŞ¹ØÏµµÄÈËÄÜ²ì¿´ËûÈËµÄ¼¼ÄÜ¡£\n");	
	}*/

	skl = ob->query_skills();
	if(!sizeof(skl)) {
		write( (ob==me ? "Äã" : ob->name()) + "Ä¿Ç°²¢Ã»ÓĞÑ§»áÈÎºÎ¼¼ÄÜ¡£\n");
		return 1;
	}
	write( (ob==me ? "Äã" : ob->name()) +"Ä¿Ç°¹²Ñ§¹ı"+chinese_number(sizeof(skl))+"ÖÖ¼¼ÄÜ£º\n\n");
	sname  = sort_array( keys(skl), (: strcmp :) );
	
	map = ob->query_skill_map();
	if( mapp(map) ) mapped = values(map);
	if( !mapped ) mapped = ({});

	lrn = ob->query_learned();
	if( !mapp(lrn) ) lrn = ([]);
	
	for(i=0; i<sizeof(skl); i++) {
		if(!find_object(SKILL_D(sname[i])) && file_size(SKILL_D(sname[i])+".c")<0) 
		{
			ob->delete_skill(sname[i]);
			write("delete obselete skill " + sname[i] + "\n");
			continue;
		}
		if (ob->prevent_shown(me,sname[i]))	continue;
		write(sprintf("%s%s%-40s" NOR " - %-10s %3d/%5d\n", 
				(lrn[sname[i]] >= (skl[sname[i]]+1) * (skl[sname[i]]+1)) ? HIM : "", 
				(member_array(sname[i], mapped)==-1? "  ": "£ª"),
				SKILL_D(sname[i])->name() + " (" + sname[i] + ")",
				skill_level(SKILL_D(sname[i])->type(), skl[sname[i]]),
				skl[sname[i]], 
				(int)lrn[sname[i]],
		));
	}
	write("\n");
	return 1;
}

string skill_level(string type, int level)
{
	int grade;

	grade = level / 20;

	switch(type) {
		case "knowledge":
			if( grade >= sizeof(knowledge_level_desc) )
				grade = sizeof(knowledge_level_desc)-1;
			return knowledge_level_desc[grade];
		default:
			if( grade >= sizeof(skill_level_desc) )
				grade = sizeof(skill_level_desc)-1;
			return skill_level_desc[grade];
	}
}

string pet_skill(object ob)
{
	string desc;
        object  *list, couple_ob;
        mapping skl, lrn, map;
        string *sname, *mapped,target,cardname;
        int i, marry_flag;
        skl = ob->query_skills();
        if(!sizeof(skl)) {
                desc =  ob->name() + "Ä¿Ç°²¢Ã»ÓĞÑ§»áÈÎºÎ¼¼ÄÜ¡£\n";
                return desc;
        }
        	desc =  ob->name() +"Ä¿Ç°ËùÑ§¹ıµÄ¼¼ÄÜ£º\n\n";
        sname  = sort_array( keys(skl), (: strcmp :) );

        map = ob->query_skill_map();
        if( mapp(map) ) mapped = values(map);
        if( !mapped ) mapped = ({});

        lrn = ob->query_learned();
        if( !mapp(lrn) ) lrn = ([]);

        for(i=0; i<sizeof(skl); i++) {
              desc +=  sprintf("%s%s%-40s" NOR " - %-10s %3d/%5d\n",
                        (lrn[sname[i]] >= (skl[sname[i]]+1) * (skl[sname[i]]+1)) ? HIM : "",
                        (member_array(sname[i], mapped)==-1? "  ": "£ª"),
                        SKILL_D(sname[i])->name() + " (" + sname[i] + ")",
                        skill_level(SKILL_D(sname[i])->type(), skl[sname[i]]),
                        skl[sname[i]], (int)lrn[sname[i]],
                );
        }
        return desc +"\n";
}


int help(object me)
{
	write(@HELP
[0;1;37m©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤[0m   
[0;1;36mÖ¸Áî¸ñÊ½ :[0;32m 

£¨1£© skills 

²éÑ¯×Ô¼ºËùÑ§¹ıµÄ¼¼ÄÜ¡£

£¨2£© skills [<Ä³ÈË>] 

Ö¸¶¨Ò»¸öºÍÄãÓĞÊ¦Í½/·òÆŞ¹ØÏµµÄ¶ÔÏó£¬¿ÉÒÔ²éÖª¶Ô·½µÄ¼¼ÄÜ×´¿ö¡£

£¨3£© skills -¼¼ÄÜÓ¢ÎÄÃû³Æ

ÔÚ¼õºÅ¡°-¡±ºó¸úÒ»¼¼ÄÜµÄÓ¢ÎÄÃû³Æ£¬½«Ö»ÁĞ³ö¸Ã¼¼ÄÜµÄµÈ¼¶×´¿ö¡£

£¨4£© skills -¼¼ÄÜÓ¢ÎÄÃû³Æ -Êı×Ö

¸ø³öÒ»¸öÉıÖÁµÚ¡°Êı×Ö¡±µÈ¼¶ËùĞèÒªµÄÇ±ÄÜÊı¹ÀËã¡£

ÎªÁË±ÜÃâË¢ÆÁ£¬¼¼ÄÜËù¶ÔÓ¦µÄÌØ¼¼ĞÅÏ¢Ã¿£²ÃëÖÓ×î¶àÏÔÊ¾Ò»´Î

[0;1;37m©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤[0m   

¹ØÓÚ¸÷ÏîµÄËµÃ÷

¡¾ÉıÖÁµÚx¼¶ËùĞèÇ±ÄÜ¡¿
¡¾ËùĞè¾­ÑéµÈ¼¶¡¿
¡¾ÔÄ¶ÁÓĞ¹ØÊé¼®ÉıÖÁµÚx¼¶ËùĞè¾­ÑéµÈ¼¶¡¿

ÎªÁË·½±ã´ó¼Ò£¬ÎÒÃÇ¸ù¾İÄãµÄÊôĞÔ×´¿ö£¬¸ø³öÒ»¸öÉıµ½ÏÂÒ»¼¶ËùĞè
Ç±ÄÜÊıÁ¿µÄ´óÖÂ¹À¼Æ¡£¶Ô´Ë×÷Ò»Ğ©ËµÃ÷£º

£á£®·çÔÆ£²£°£°£µÖĞÑ§Ï°ËùºÄ·ÑµÄÇ±ÄÜÊıÃ»ÓĞËæ»ú°Ú¶¯£¬Õâ¸öÊı×Ö
ÊÇ±È½Ï×¼È·µÄ¹À¼Æ£¬ÓÉÓÚÄã»¨·ÑµÄÇ±ÄÜ²»Í¬£¬ÔÚËÄÉáÎåÈëÊ±»áÓĞÒ»
¶¨²îÒì£¬´Ë¹À¼ÆÊÇ°´ÕÕÃ¿´ÎÊ¹ÓÃ£±£°£°Ç±ÄÜµãµÄ¹«Ê½¼ÆËãµÄ¡£
£¨¾ßÌå²Î¼û£è£å£ì£ğ¡¡£ì£å£á£ò£îµÄËµÃ÷£©

£â£®´Ë¹ÀËãÊÇ°´ÕÕÄãµ±Ç°²ÅÖÇ¡¢Ãñ×å¡¢ÒÔ¼°µ±Ç°¼¼ÄÜµÈ¼¶Ëù¶ÔÓ¦µÄ
Ñ§Ï°ÄÑ¶ÈËù¼ÆËãµÄ£¬Èç¹ûÄãµÄ²ÅÖÇ¡¢»òÕß¸Ã¼¼ÄÜµÄÑ§Ï°ÄÑ¶ÈÒÔºó±ä
¶¯ÁË£¬Ôò´ËÊı×ÖÒ²½«±ä¶¯¡£

£ã£®¶ÁÊéÊ¶×Ö£¨literate£©Ç£Éæµ½²ÅÖÇµÄÌá¸ß£¬ËùÒÔÆäÊµ¼ÊËùĞèµÄ
±ÈÏÔÊ¾µÄÒªÉÙºÜ¶à¡£
[1;31m
£ä£®ËùÓĞºÄ·ÑµÄÇ±ÄÜµãÖ»ÔÚµ±Ç°µÈ¼¶ÓĞĞ§£¬¼´Ê¹ÏµÍ³ÏÔÊ¾ĞèÒª20000
µãÉıÖÁµÚ£±£°£°¼¶£¬Èç¹ûÄãÏÖÔÚÖ»ÓĞ£²£°¼¶£¬Ò»´ÎÓÃÈ¥20000µãÒ²Ö»
ÄÜÉıµ½µÚ£²£±¼¶£¬¶ø²»»áÖ±½ÓÉıµ½µÚ£±£°£°¼¶¡£É÷Ö®£¡£¡£¡
[0;32m

¡¾Îä¹¦ÏµÊı¡¿¼¼ÄÜÖ÷Òª²ÎÊı£¬¾ö¶¨¸ÃÎä¹¦ÔÚÄ³Ò»¾­Ñé¶Î¿ÉÒÔÑ§µ½µÄ
×î¸ßµÈ¼¶¡£Îä¹¦ÏµÊıºÍÎä¹¦µÈ¼¶ÊÇ¾ö¶¨Îä¹¦µÄÃüÖĞÂÊµÄÁ½´óÖ÷ÒªÒòËØ¡£

¡¾ÉËº¦µÈ¼¶¡¿ĞŞÊÎÎä¹¦µÄÉËº¦ÂÊ£¬ÉËº¦Á¦Ò»°ãÈ¡¾öÓÚÄãµÄÁ¦Á¿¡¢¼ÓÁ¦
£¨enforce£©¡¢ÎäÆ÷¡¢Ïà¶Ô¾­ÑéµÈ¼¶µÈ£¬¡¾ÉËº¦µÈ¼¶¡¿¶ÔÇ°Á½¸öÒòËØ
¼Ó³É¡£100Ïàµ±ÓÚÀ´Ô´ÓÚÁ¦Á¿ºÍ¼ÓÁ¦µÄÉËº¦Á¦Ôö´ó10£¥¡£

¡¾ÃüÖĞµÈ¼¶¡¿ÀàËÆÓÚÉÏÒ»Ïî£¬¶ÔÎä¹¦ÃüÖĞÂÊµÄ¼Ó³É£¬Á½¸öÆäËûÍêÈ«
ÏàÍ¬µÄ¼¼ÄÜ£¬ÃüÖĞµÈ¼¶£²£°£°µÄ±ÈÃüÖĞµÈ¼¶£°µÄÃüÖĞÂÊ¸ß£²£°£¥

¡¾Ñ§Ï°ÄÑ¶È¡¿²Î¿´ÃüÁî£ì£å£á£ò£îµÄ¹«Ê½ËµÃ÷

¡¾ÑĞ¾¿ÄÑ¶È¡¿Ò»°ãÀ´Ëµ£¬ÑĞ¾¿£¨£ò£å£ó£å£á£ò£ã£è£©ËùĞèÇ±ÄÜÊıÎªÆÕ
Í¨Ñ§Ï°ËùĞèµÄ£²£°±¶£¬ÑĞ¾¿ÄÑ¶ÈÊÇÔÚ´Ë»ù´¡ÉÏµÄ¼ÓÈ¨¡£

¡¾Á·Ï°¼¶Êı¡¿¸Ã¼¼ÄÜÄÜ¹»Á·Ï°£¨£ğ£ò£á£ã£ô£é£ã£å£©µ½µÄ×î¸ßµÈ¼¶¡£

¡¾ÕĞ¼ÜÓĞĞ§ÏµÊı¡¿Ò»°ãÀ´Ëµ£¬¡¾Îä¹¦ÏµÊı¡¿±ãÊÇ¼¼ÄÜµÄÕĞ¼ÜÏµÊı£¬Î¨
ÓĞÒ»Ğ©ÌØ¶¨µÄÎä¹¦»áÓĞ×¨ÃÅµÄÕĞ¼ÜÏµÊı¡£

¡¾½ğ¸ÕÀàÓĞĞ§ÏµÊı¡¿¶ÔÌú²¼ÉÀÀàÎä¹¦×÷ÓÃÓÚ»¤¼×µÄĞŞÊÎ£¬ÏµÊıÔ½¸ß£¬
»¤¼××÷ÓÃ¾ÍÔ½Ã÷ÏÔ¡£

¡¾½ğ¸ÕÀà·´µ¯ÏµÊı¡¿ÓÃÀ´¼ÆËãÌú²¼ÉÀÀàÎä¹¦µÄ·´µ¯ÉËº¦Á¦¡£


[0;1;37m©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤©¤[0m   
HELP
    );
    return 1;
}
